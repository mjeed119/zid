<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>بوابة الدرجات</title>
  <link rel="stylesheet" href="styles.css" />
  <style>
    .header-row {
      display:flex;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
      gap:8px;
    }
    .btn {
      padding:8px 12px;
      border:1px solid #cfd3df;
      border-radius:8px;
      background:#f5f7ff;
      cursor:pointer;
    }
    .btn:disabled { opacity:.5; cursor:not-allowed; }
    .grades { width:100%; border-collapse: collapse; margin-top: 8px; }
    .grades th, .grades td { border:1px solid #e8eaf2; padding:10px; text-align:center; }
    .grades th { background:#f3f5fb; }
    .card { background:#fff; border:1px solid #e6e8ef; border-radius:12px; padding:16px; margin:12px 0; box-shadow:0 1px 3px rgba(0,0,0,.05); }
    body { font-family: system-ui, -apple-system, "Segoe UI", Tahoma, Arial; background:#f6f7fb; margin:0; }
    .container { max-width: 900px; margin: 24px auto; padding: 16px; }
  </style>
</head>
<body>
  <main class="container">
    <h1 style="text-align: center;">ثانوية زيد بن سهل الانصاري</h1><br>
    <h1>بوابة الدرجات</h1>

    <!-- اختيار الفصل -->
    <section class="card">
      <label for="classSelect">اختر الفصل:</label>
      <select id="classSelect"><option value="">— اختر —</option></select>
    </section>

    <!-- اختيار الطالب -->
    <section class="card" id="studentSection" style="display:none">
      <label for="studentSelect">اختر اسمك:</label>
      <select id="studentSelect"><option value="">— اختر —</option></select>
    </section>

    <!-- بطاقة الدرجات -->
    <section class="card" id="gradesSection" style="display:none">
      <div class="header-row">
        <h2 id="studentHeader"></h2>
        <!-- ✅ زر الاعتراض هنا بجانب الاسم -->
        <button id="objectionBtn" class="btn" disabled>تقديم اعتراض</button>
      </div>
      <div id="gradesTableWrapper"></div>
      <div class="totals">
        <div>المجموع: <span id="totalScore">—</span></div>
        <div>النسبة: <span id="percentScore">—</span>%</div>
      </div>
    </section>

    <footer><small>© <span id="year"></span> معلم التقنية الرقمية: عبدالمجيد الغامدي</small></footer>
  </main>

  <script>
    // رابط النموذج الأساسي
    const GOOGLE_FORMS_OBJECTION_BASE =
      "https://docs.google.com/forms/d/e/1FAIpQLSeIvg3cD2YHY-wfpuX6d15xXxjft2BVfpdKI0NRaRG3BY98yg/viewform?usp=pp_url";

    // entry IDs من رابط pre-filled
    const ENTRY_NAME_ID  = "entry.284994531";   // اسم الطالب
    const ENTRY_CLASS_ID = "entry.1748397745"; // الفصل

    const COLUMNS = [
      { key: "Homework", label: "الواجبات" },
      { key: "Research", label: "البحث" },
      { key: "ClassActivity", label: "النشاط الصفي" },
      { key: "Absence", label: "الغياب" }, // مستبعد من المجموع
      { key: "Theoretical", label: "الاختبار النظري" },
      { key: "Practical", label: "الاختبار العملي" }
    ];

    const classSelect        = document.getElementById("classSelect");
    const studentSection     = document.getElementById("studentSection");
    const studentSelect      = document.getElementById("studentSelect");
    const gradesSection      = document.getElementById("gradesSection");
    const studentHeader      = document.getElementById("studentHeader");
    const gradesTableWrapper = document.getElementById("gradesTableWrapper");
    const totalScoreEl       = document.getElementById("totalScore");
    const percentScoreEl     = document.getElementById("percentScore");
    const objectionBtn       = document.getElementById("objectionBtn");

    let DATA = null, currentClass = null;

    async function loadData() {
      let res = await fetch("students.json", { cache: "no-store" });
      if (!res.ok) res = await fetch("data/students.json", { cache: "no-store" });
      if (!res.ok) throw new Error("تعذّر تحميل data/students.json");
      DATA = await res.json();
      const classes = Object.keys(DATA.classes || {});
      classes.sort(new Intl.Collator('ar').compare);
      for (const c of classes) {
        const opt = document.createElement("option");
        opt.value = c; opt.textContent = c;
        classSelect.appendChild(opt);
      }
    }

    function populateStudents(className) {
      studentSelect.innerHTML = '<option value="">— اختر —</option>';
      const students = DATA.classes[className] || [];
      students.sort((a, b) => new Intl.Collator('ar').compare(a.name, b.name));
      for (const s of students) {
        const opt = document.createElement("option");
        opt.value = s.id; opt.textContent = s.name;
        studentSelect.appendChild(opt);
      }
    }

    function renderGrades(student) {
      studentHeader.textContent = `${student.name} — ${currentClass}`;
      const table = document.createElement("table");
      table.className = "grades";
      const thead = document.createElement("thead");
      thead.innerHTML = "<tr><th>البند</th><th>الدرجة</th></tr>";
      table.appendChild(thead);

      const tbody = document.createElement("tbody");
      const EXCLUDE_FROM_TOTAL = new Set(['Absence']);
      let total = 0, maxTotal = 0;

      for (const col of COLUMNS) {
        const score = Number(student.grades?.[col.key] ?? 0);
        const outOf = Number(student.max?.[col.key] ?? 0);

        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${col.label}</td><td>${score}</td>`;
        tbody.appendChild(tr);

        if (!EXCLUDE_FROM_TOTAL.has(col.key)) {
          total += score;
          maxTotal += outOf;
        }
      }

      table.appendChild(tbody);
      gradesTableWrapper.innerHTML = "";
      gradesTableWrapper.appendChild(table);

      totalScoreEl.textContent = `${total} / ${maxTotal}`;
      percentScoreEl.textContent = maxTotal ? ((total / maxTotal) * 100).toFixed(2) : "0.00";

      // تفعيل الزر بعد اختيار الطالب
      objectionBtn.disabled = false;
      objectionBtn.onclick = () => {
        const params = new URLSearchParams();
        params.set(ENTRY_CLASS_ID, currentClass);
        params.set(ENTRY_NAME_ID, student.name);
        const url = GOOGLE_FORMS_OBJECTION_BASE + "&" + params.toString();
        window.open(url, "_blank");
      };
    }

    classSelect.addEventListener("change", () => {
      currentClass = classSelect.value || null;
      gradesSection.style.display = "none";
      if (!currentClass) { studentSection.style.display = "none"; return; }
      populateStudents(currentClass);
      studentSection.style.display = "block";
    });

    studentSelect.addEventListener("change", () => {
      const studentId = studentSelect.value || null;
      gradesSection.style.display = "none";
      if (!studentId) return;
      const list = DATA.classes[currentClass] || [];
      const student = list.find(s => String(s.id) === String(studentId));
      if (!student) return;
      renderGrades(student);
      gradesSection.style.display = "block";
    });

    document.getElementById("year").textContent = new Date().getFullYear();
    loadData().catch(e => { alert(e.message); console.error(e); });
  </script>
</body>
</html>