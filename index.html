<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>بوابة الدرجات</title>
  <link rel="stylesheet" href="styles.css" />
  <style>
    /* وضع فاتح افتراضي */
    :root{
      --bg:#f5f7fb; --card:#ffffff; --border:#e6e8ef; --muted:#7c8499;
      --primary:#3b5bdb; --primary-weak:#ecf1ff; --text:#0f1220;
    }
    /* إجبار فاتح/داكن عبر data-theme */
    html[data-theme="light"]{
      --bg:#f5f7fb; --card:#ffffff; --border:#e6e8ef; --muted:#7c8499;
      --primary:#3b5bdb; --primary-weak:#ecf1ff; --text:#0f1220;
    }
    html[data-theme="dark"]{
      --bg:#0f1220; --card:#171a2b; --border:#2a2e43; --muted:#a2a8c3;
      --primary:#7b90ff; --primary-weak:#1e2450; --text:#e8ecff;
    }

    body{background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,"Segoe UI",Tahoma,Arial;margin:0}
    .container{max-width:900px;margin:24px auto;padding:16px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;
          padding:18px;margin:14px 0;box-shadow:0 6px 18px rgba(0,0,0,.06)}
    h1,h2,h3{margin:.25rem 0 .5rem}
    label{font-weight:600;margin-bottom:6px;display:inline-block}
    select{padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:#fff}
    .grades{width:100%;border-collapse:collapse;margin-top:8px;border-radius:12px;overflow:hidden}
    .grades th,.grades td{border:1px solid var(--border);padding:12px;text-align:center}
    .grades th{background:#f3f5fb}
    html[data-theme="dark"] .grades th{background:#1d223a}
    .btn{padding:10px 14px;border:1px solid #cfd3df;border-radius:10px;background:var(--primary-weak);
         cursor:pointer;font-weight:600;color:var(--text)}
    .btn:hover{filter:brightness(.98)}
    .muted{color:var(--muted);font-size:12px}
    .header-row{display:flex;align-items:center;justify-content:space-between;gap:8px;flex-wrap:wrap}
    .list{list-style:none;padding:0;margin:0}
    .res-item{display:flex;justify-content:space-between;gap:12px;align-items:center;
              padding:10px 12px;border:1px solid var(--border);border-radius:10px;margin-bottom:8px;
              background:#fff}
    html[data-theme="dark"] .res-item{background:#14182b}
    .res-item a{font-weight:600;text-decoration:none}
    .res-meta{color:var(--muted);font-size:12px}
    .ann-list{list-style:none;padding:0;margin:0}
    .ann-item{display:flex;gap:12px;align-items:flex-start;padding:12px;border:1px solid var(--border);
              border-radius:12px;background:var(--card);margin-bottom:10px}
    .badge{padding:4px 8px;border-radius:999px;font-size:12px;font-weight:700;white-space:nowrap}
    .badge.hw{background:#fff3bf}
    .badge.exam{background:#ffe3e3}
    .badge.info{background:#e7f5ff}
    .ann-date{color:var(--muted);font-size:12px}
    .topbar{display:flex;justify-content:space-between;align-items:center;gap:12px}

    /* شريط إعلان متحرك (يعرض كل الإعلانات) */
    #topNotice{display:none;margin:12px 0 16px;padding:0;border:1px solid #ffd8a8;background:#fff4e6;border-radius:10px;overflow:hidden}
    .ticker{position:relative;white-space:nowrap;overflow:hidden;padding:10px 14px}
    .ticker__track{display:inline-block;will-change:transform;animation:marquee 18s linear infinite}
    @keyframes marquee{
      0%{transform:translateX(0)}
      100%{transform:translateX(-50%)}
    }
    .ticker__item{margin-inline-end:24px}
  </style>
</head>
<body>
  <main class="container">
    <div class="topbar">
      <h1 style="margin:0;">بوابة الدرجات</h1>
      <button class="btn" id="toggleTheme">الوضع الداكن</button>
    </div>

    <!-- شريط الإعلان -->
    <div id="topNotice">
      <div class="ticker">
        <div id="tickerTrack" class="ticker__track"></div>
      </div>
    </div>

    <section class="card">
      <label for="classSelect">اختر الفصل:</label>
      <select id="classSelect"><option value="">— اختر —</option></select>
    </section>

    <section class="card" id="studentSection" style="display:none">
      <label for="studentSelect">اختر اسمك:</label>
      <select id="studentSelect"><option value="">— اختر —</option></select>
    </section>

    <section class="card" id="gradesSection" style="display:none">
      <div class="header-row">
        <h2 id="studentHeader"></h2>
        <button id="objectionBtn" class="btn" disabled>تقديم اعتراض</button>
      </div>
      <div id="gradesTableWrapper"></div>
      <div class="totals">
        <div>المجموع: <span id="totalScore">—</span></div>
        <div>النسبة: <span id="percentScore">—</span>%</div>
      </div>
    </section>

    <section class="card" id="resourcesSection">
      <h2>المراجع والخطط</h2>
      <h3>أوراق العمل / المذكرات</h3>
      <ul id="wsList" class="list"></ul>
      <h3>الخطط الأسبوعية</h3>
      <ul id="plansList" class="list"></ul>
      <h3 id="bookHeader" style="display:none;">كتاب الطالب</h3>
      <ul id="bookList" class="list"></ul>
      <h3 id="linksHeader" style="display:none;">روابط مفيدة</h3>
      <ul id="linksList" class="list"></ul>
    </section>

    <section class="card" id="announcementsSection">
      <h2>الإعلانات</h2>
      <ul id="annList" class="ann-list"></ul>
      <div class="muted">   <code></code></div>
    </section>

    <footer><small>© <span id="year"></span> معلم التقنية الرقمية: عبدالمجيد الغامدي</small></footer>
  </main>

  <script>
    /* ====== تبديل الوضع (يبدأ دائمًا بالفاتح) ====== */
    const toggleThemeBtn = document.getElementById("toggleTheme");
    function applyTheme(t){
      document.documentElement.dataset.theme = t;
      localStorage.setItem("theme", t);
      toggleThemeBtn.textContent = t === "dark" ? "الوضع الفاتح" : "الوضع الداكن";
    }
    // يبدأ دائمًا بالفاتح إلا إذا محفوظ "داكن"
    const savedTheme = localStorage.getItem("theme");
    applyTheme(savedTheme ? savedTheme : "light");
    toggleThemeBtn.onclick = ()=> applyTheme(
      (document.documentElement.dataset.theme === "dark") ? "light" : "dark"
    );

    /* ====== ثوابت الاعتراض ====== */
    const GOOGLE_FORMS_OBJECTION_BASE =
      "https://docs.google.com/forms/d/e/1FAIpQLSeIvg3cD2YHY-wfpuX6d15xXxjft2BVfpdKI0NRaRG3BY98yg/viewform?usp=pp_url";
    const ENTRY_NAME_ID  = "entry.284994531";
    const ENTRY_CLASS_ID = "entry.1748397745";

    /* ====== أعمدة الدرجات ====== */
    const COLUMNS = [
      { key: "Homework", label: "الواجبات" },
      { key: "Research", label: "البحث" },
      { key: "ClassActivity", label: "النشاط الصفي" },
      { key: "Absence", label: "الغياب" },
      { key: "Theoretical", label: "الاختبار النظري" },
      { key: "Practical", label: "الاختبار العملي" }
    ];
    const EXCLUDE_FROM_TOTAL = new Set(['Absence']);

    /* ====== عناصر DOM ====== */
    const classSelect = document.getElementById("classSelect");
    const studentSection = document.getElementById("studentSection");
    const studentSelect = document.getElementById("studentSelect");
    const gradesSection = document.getElementById("gradesSection");
    const studentHeader = document.getElementById("studentHeader");
    const gradesTableWrapper = document.getElementById("gradesTableWrapper");
    const totalScoreEl = document.getElementById("totalScore");
    const percentScoreEl = document.getElementById("percentScore");
    const objectionBtn = document.getElementById("objectionBtn");

    const wsList = document.getElementById("wsList");
    const plansList = document.getElementById("plansList");
    const linksList = document.getElementById("linksList");
    const linksHeader = document.getElementById("linksHeader");
    const bookList = document.getElementById("bookList");
    const bookHeader = document.getElementById("bookHeader");
    const tickerTrack = document.getElementById("tickerTrack");
    const topNotice = document.getElementById("topNotice");

    let DATA = null, currentClass = null;

    /* ====== تحميل بيانات الطلاب ====== */
    async function loadData() {
      let res = await fetch("students.json", { cache: "no-store" });
      if (!res.ok) res = await fetch("data/students.json", { cache: "no-store" });
      if (!res.ok) throw new Error("تعذّر تحميل data/students.json");
      DATA = await res.json();
      const classes = Object.keys(DATA.classes || {});
      classes.sort(new Intl.Collator('ar').compare);
      for (const c of classes) {
        const opt = document.createElement("option");
        opt.value = c; opt.textContent = c;
        classSelect.appendChild(opt);
      }
    }

    function populateStudents(className) {
      studentSelect.innerHTML = '<option value="">— اختر —</option>';
      const students = DATA.classes[className] || [];
      students.sort((a,b)=> new Intl.Collator('ar').compare(a.name,b.name));
      for (const s of students) {
        const opt = document.createElement("option");
        opt.value = s.id; opt.textContent = s.name;
        studentSelect.appendChild(opt);
      }
    }

    function renderGrades(student) {
      studentHeader.textContent = `${student.name} — ${currentClass}`;
      const table = document.createElement("table");
      table.className = "grades";
      const thead = document.createElement("thead");
      thead.innerHTML = "<tr><th>البند</th><th>الدرجة</th></tr>";
      table.appendChild(thead);
      const tbody = document.createElement("tbody");
      let total = 0, maxTotal = 0;
      for (const col of COLUMNS) {
        const score = Number(student.grades?.[col.key] ?? 0);
        const outOf = Number(student.max?.[col.key] ?? 0);
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${col.label}</td><td>${score}</td>`;
        tbody.appendChild(tr);
        if (!EXCLUDE_FROM_TOTAL.has(col.key)) { total += score; maxTotal += outOf; }
      }
      table.appendChild(tbody);
      gradesTableWrapper.innerHTML = ""; gradesTableWrapper.appendChild(table);
      totalScoreEl.textContent = `${total} / ${maxTotal}`;
      percentScoreEl.textContent = maxTotal ? ((total / maxTotal) * 100).toFixed(2) : "0.00";
      objectionBtn.disabled = false;
      objectionBtn.onclick = () => {
        const params = new URLSearchParams();
        params.set(ENTRY_CLASS_ID, currentClass);
        params.set(ENTRY_NAME_ID, student.name);
        const url = GOOGLE_FORMS_OBJECTION_BASE + "&" + params.toString();
        window.open(url, "_blank");
      };
    }

    /* ====== الموارد ====== */
    async function loadResources() {
      try {
        let res = await fetch("data/resources.json", { cache: "no-store" });
        if (!res.ok) res = await fetch("resources.json", { cache: "no-store" });
        if (!res.ok) return;
        const data = await res.json();

        wsList.innerHTML = "";
        (data.worksheets || []).forEach(w => {
          const li = document.createElement("li");
          li.className = "res-item";
          li.innerHTML = `<a href="${w.file}" target="_blank" rel="noopener">${w.title}</a>
                          <span class="res-meta">PDF</span>`;
          wsList.appendChild(li);
        });

        plansList.innerHTML = "";
        (data.plans || []).forEach(p => {
          const li = document.createElement("li");
          li.className = "res-item";
          li.innerHTML = `<a href="${p.file}" target="_blank" rel="noopener">${p.title}</a>
                          <span class="res-meta">خطة أسبوعية</span>`;
          plansList.appendChild(li);
        });

        bookList.innerHTML = "";
        const books = data.book || [];
        if (books.length > 0) {
          bookHeader.style.display = "block";
          books.forEach(b => {
            const li = document.createElement("li");
            li.className = "res-item";
            li.innerHTML = `<a href="${b.file}" target="_blank" rel="noopener">${b.title}</a>
                            <span class="res-meta">PDF</span>`;
            bookList.appendChild(li);
          });
        } else {
          bookHeader.style.display = "none";
        }

        linksList.innerHTML = "";
        const hasLinks = (data.links || []).length > 0;
        linksHeader.style.display = hasLinks ? "block" : "none";
        (data.links || []).forEach(l => {
          const li = document.createElement("li");
          li.className = "res-item";
          li.innerHTML = `<a href="${l.url}" target="_blank" rel="noopener">${l.title}</a>
                          <span class="res-meta">رابط</span>`;
          linksList.appendChild(li);
        });
      } catch(e) { console.warn("resources error", e); }
    }

    /* ====== الإعلانات + الشريط المتحرك (كل الإعلانات) ====== */
    async function loadAnnouncements() {
      try {
        let res = await fetch("data/announcements.json", {cache:"no-store"});
        if (!res.ok) res = await fetch("announcements.json", {cache:"no-store"});
        if (!res.ok) return;
        const items = await res.json();

        // قائمة الإعلانات
        const ul = document.getElementById("annList");
        ul.innerHTML = "";
        items.sort((a,b)=> new Date(b.date) - new Date(a.date));
        for (const it of items) {
          const li = document.createElement("li");
          li.className = "ann-item";
          const dateStr = new Date(it.date).toLocaleDateString('ar-SA');
          const badgeClass = it.type === "exam" ? "exam" : (it.type === "hw" ? "hw" : "info");
          li.innerHTML = `<span class="badge ${badgeClass}">${it.type === "exam" ? "اختبار" : it.type === "hw" ? "واجب" : "إعلان"}</span>
            <div>
              <div style="font-weight:700">${it.title}</div>
              <div>${it.text || ""}</div>
              <div class="ann-date">${dateStr}</div>
            </div>`;
          ul.appendChild(li);
        }

        // شريط أعلى الصفحة (يعرض كل الإعلانات بوضوح)
        if (items.length){
          const texts = items.map(it => {
            const prefix = (it.type === "exam" ? "📘 اختبار: " : it.type === "hw" ? "📝 واجب: " : "ℹ️ إعلان: ");
            return prefix + it.title;
          });
          // كرر القائمة مرتين عشان يكون التمرير مستمر
          tickerTrack.innerHTML =
            texts.map(t => `<span class="ticker__item">${t}</span>`).join("") +
            texts.map(t => `<span class="ticker__item">${t}</span>`).join("");
          topNotice.style.display = "block";
        } else {
          topNotice.style.display = "none";
        }
      } catch(e) { console.warn("announcements error", e); }
    }

    /* ====== تفاعلات ====== */
    classSelect.addEventListener("change", () => {
      currentClass = classSelect.value || null;
      gradesSection.style.display = "none";
      objectionBtn.disabled = true;
      if (!currentClass) { studentSection.style.display = "none"; return; }
      populateStudents(currentClass);
      studentSection.style.display = "block";
    });

    studentSelect.addEventListener("change", () => {
      const studentId = studentSelect.value || null;
      gradesSection.style.display = "none";
      if (!studentId) return;
      const list = DATA.classes[currentClass] || [];
      const student = list.find(s => String(s.id) === String(studentId));
      if (!student) return;
      renderGrades(student);
      gradesSection.style.display = "block";
    });

    document.getElementById("year").textContent = new Date().getFullYear();

    // تحميل الكل
    Promise.all([loadData(), loadResources()]).then(loadAnnouncements).catch(e => { alert(e.message); console.error(e); });
  </script>
</body>
</html>